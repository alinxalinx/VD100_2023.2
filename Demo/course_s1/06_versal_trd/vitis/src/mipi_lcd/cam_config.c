#include "cam_config.h"

#include "xiicps.h"

#include "xparameters.h"
#include "i2c/PS_i2c.h"

//#include "imx214_mode_tbls.h"
struct reginfo sensor_init_data[] =
{	
		{0x0103,0x01},
		{0x0303,0x01},
		{0x0305,0x44},
		{0x0306,0x00},
		{0x0307,0x00},
		{0x0308,0x03},
		{0x0309,0x04},
		{0x032a,0x00},
		{0x031e,0x09},
		{0x0325,0x48},
		{0x0328,0x07},
		{0x300d,0x11},
		{0x300e,0x11},
		{0x300f,0x11},
		{0x3010,0x01},
		{0x3012,0x41},
		{0x3016,0xf0},
		{0x3018,0xf0},
		{0x3028,0xf0},
		{0x301e,0x98},
		{0x3010,0x04},
		{0x3011,0x06},
		{0x3031,0xa9},
		{0x3103,0x48},
		{0x3104,0x01},
		{0x3106,0x10},
		{0x3400,0x04},
		{0x3025,0x03},
		{0x3425,0x51},
		{0x3428,0x01},
		{0x3406,0x08},
		{0x3408,0x03},
		{0x3501,0x05},
		{0x3502,0x21},
		{0x3505,0x83},
		{0x3508,0x02},//gain
		{0x3509,0x80},
		{0x350a,0x04},
		{0x350b,0x00},
		{0x350c,0x00},
		{0x350d,0x80},
		{0x350e,0x04},
		{0x350f,0x00},
		{0x3600,0x00},
		{0x3626,0xff},
		{0x3605,0x50},
		{0x3609,0xb5},
		{0x3610,0x69},
		{0x360c,0x01},
		{0x3628,0xa4},
		{0x3629,0x6a},
		{0x362d,0x10},
		{0x3660,0x43},
		{0x3661,0x06},
		{0x3662,0x00},
		{0x3663,0x28},
		{0x3664,0x0d},
		{0x366a,0x38},
		{0x366b,0xa0},
		{0x366d,0x00},
		{0x366e,0x00},
		{0x3680,0x00},
		{0x36c0,0x00},
		{0x3621,0x81},
		{0x3634,0x31},
		{0x3620,0x00},
		{0x3622,0x00},
		{0x362a,0xd0},
		{0x362e,0x8c},
		{0x362f,0x98},
		{0x3630,0xb0},
		{0x3631,0xd7},
		{0x3701,0x0f},
		{0x3737,0x02},
		{0x3741,0x04},
		{0x373c,0x0f},
		{0x373b,0x02},
		{0x3705,0x00},
		{0x3706,0x50},
		{0x370a,0x00},
		{0x370b,0xe4},
		{0x3709,0x4a},
		{0x3714,0x21},
		{0x371c,0x00},
		{0x371d,0x08},
		{0x375e,0x0e},
		{0x3760,0x13},
		{0x3776,0x10},
		{0x3781,0x02},
		{0x3782,0x04},
		{0x3783,0x02},
		{0x3784,0x08},
		{0x3785,0x08},
		{0x3788,0x01},
		{0x3789,0x01},
		{0x3797,0x84},
		{0x3798,0x01},
		{0x3799,0x00},
		{0x3761,0x02},
		{0x3762,0x0d},
		{0x3800,0x00},//X start 0
		{0x3801,0x00},//X start
		{0x3802,0x00},//y start 0
		{0x3803,0x0c},//y start
		{0x3804,0x0e},//X end 3839
		{0x3805,0xff},//X end
		{0x3806,0x08},//y end 2159
		{0x3807,0x6f},//y end
		{0x3808,0x07},//X output size 1920
		{0x3809,0x80},//X output size
		{0x380a,0x04},//y output size 1080
		{0x380b,0x38},//y output size


		{0x3813,0x04},
		{0x3814,0x01},
		{0x3815,0x01},
		{0x3816,0x01},
		{0x3817,0x01},
		{0x381c,0x00},
		{0x3820,0x00},
		{0x3821,0x04},
		{0x3823,0x18},
		{0x3826,0x00},
		{0x3827,0x01},
		{0x3832,0x02},
		{0x383c,0x48},
		{0x383d,0xff},
		{0x3843,0x20},
		{0x382d,0x08},
		{0x3d85,0x0b},
		{0x3d84,0x40},
		{0x3d8c,0x63},
		{0x3d8d,0x00},
		{0x4000,0x78},
		{0x4001,0x2b},
		{0x4005,0x40},
		{0x4028,0x2f},
		{0x400a,0x01},
		{0x4010,0x12},
		{0x4008,0x02},
		{0x4009,0x0d},
		{0x401a,0x58},
		{0x4050,0x00},
		{0x4051,0x01},
		{0x4052,0x00},
		{0x4053,0x80},
		{0x4054,0x00},
		{0x4055,0x80},
		{0x4056,0x00},
		{0x4057,0x80},
		{0x4058,0x00},
		{0x4059,0x80},
		{0x430b,0xff},
		{0x430c,0xff},
		{0x430d,0x00},
		{0x430e,0x00},
		{0x4501,0x18},
		{0x4502,0x00},
		{0x4643,0x00},
		{0x4640,0x01},
		{0x4641,0x04},
		{0x480e,0x00},
		{0x4813,0x00},
		{0x4815,0x2b},
		{0x486e,0x36},
		{0x486f,0x84},
		{0x4860,0x00},
		{0x4861,0xa0},
		{0x484b,0x05},
		{0x4850,0x00},
		{0x4851,0xaa},
		{0x4852,0xff},
		{0x4853,0x8a},
		{0x4854,0x08},
		{0x4855,0x30},
		{0x4800,0x00},
		{0x4837,0x0e},
		{0x484a,0x3f},
		{0x5000,0xc9},
		{0x5001,0x43},
		{0x5002,0x00},
		{0x5200,0x00},//defective pixel cancellation
		{0x5211,0x03},
		{0x5291,0x03},
		{0x520d,0x0f},
		{0x520e,0xfd},
		{0x520f,0xa5},
		{0x5210,0xa5},
		{0x528d,0x0f},
		{0x528e,0xfd},
		{0x528f,0xa5},
		{0x5290,0xa5},
		{0x5004,0x40},
		{0x5005,0x00},
		{0x5180,0x00},
		{0x5181,0x10},
		{0x5182,0x0f},
		{0x5183,0xff},
		{0x5140,0x04}, //awb gain b[11:8]
		{0x5141,0x00}, //awb gain b[7:0]
		{0x5142,0x00}, //awb gain g[11:8]
		{0x5143,0x00}, //awb gain g[7:0]
		{0x5144,0x04}, //awb gain r[11:8]
		{0x5145,0x00}, //awb gain r[7:0]
		{0x5148,0x07}, //awb en
		{0x580b,0x03},
		{0x4d00,0x03},
		{0x4d01,0xe9},
		{0x4d02,0xba},
		{0x4d03,0x66},
		{0x4d04,0x46},
		{0x4d05,0xa5},
		{0x3603,0x3c},
		{0x3703,0x26},
		{0x3709,0x49},
		{0x3708,0x2d},
		{0x3719,0x1c},
		{0x371a,0x06},
		{0x4000,0x79},
		{0x380c,0x02},//hts 669
		{0x380d,0x9d},//hts
		{0x380e,0x0a},//vts 2690
		{0x380f,0x82},//vts
		{0x3501,0x05},
		{0x3502,0x21},
		{0x0100,0x01},
		{0x0100,0x01},
		{0x0100,0x01},
		{0x0100,0x01},
		{SEQUENCE_END, 0x00}
};


int ov5640_read(XIicPs *IicInstance,u16 addr,u8 *read_buf)
{
	*read_buf=i2c_reg16_read(IicInstance,0x36,addr);
	return XST_SUCCESS;
}

int ov5640_write(XIicPs *IicInstance,u16 addr,u8 data)
{

	return i2c_reg16_write(IicInstance,0x36,addr,data);
}

/* write a array of registers  */
void sensor_write_array(XIicPs *IicInstance, struct reginfo *regarray)
{
	int i = 0;
	while (regarray[i].reg != SEQUENCE_END) {
		if(regarray[i].reg == SEQUENCE_WAIT_MS)
			usleep(regarray[i].val*1000);
		else
			ov5640_write(IicInstance,regarray[i].reg,regarray[i].val);
		i++;
	}

}




int sensor_init(XIicPs *IicInstance)
{

	u8 model_id[3] ;
	ov5640_read(IicInstance, 0x300a, &model_id[0]);
	ov5640_read(IicInstance, 0x300b, &model_id[1]);
	ov5640_read(IicInstance, 0x300c, &model_id[2]);
	xil_printf("model id, 0x%x 0x%x 0x%x\r\n", model_id[0], model_id[1],model_id[2]);

	sensor_write_array(IicInstance,sensor_init_data);
	return 0;
}


